apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "valkey.fullname" . }}-init-scripts
  labels:
    {{- include "valkey.labels" . | nindent 4 }}
data:
  init.sh: |-
    #!/bin/sh
    set -eu

    # Default config paths
    VALKEY_CONFIG=${VALKEY_CONFIG_PATH:-/data/conf/valkey.conf}

    LOGFILE="/data/init.log"
    DATA_DIR="/data/conf"

    # Logging function (outputs to stderr and file)
    log() {
      echo "$(date) $1" | tee -a "$LOGFILE" >&2
    }

    {{- if .Values.auth.enabled }}
    # Function to get password for a user
    # Usage: get_user_password <username> [password_key]
    # Returns: password via stdout, exits with error if not found
    get_user_password() {
      username="$1"
      password_key="${2:-$username}"
      password=""

      {{- if .Values.auth.usersExistingSecret }}
      # Try to get password from existing secret first (priority)
      if [ -f "/valkey-users-secret/$password_key" ]; then
        password=$(cat "/valkey-users-secret/$password_key")
        log "Using password from existing secret for user $username"
      elif [ -f "/valkey-auth-secret/${username}-password" ]; then
        # Fallback to inline password
        password=$(cat "/valkey-auth-secret/${username}-password")
        log "Using inline password for user $username"
      else
        log "ERROR: No password found for user $username"
        return 1
      fi
      {{- else }}
      # Use inline password only
      if [ -f "/valkey-auth-secret/${username}-password" ]; then
        password=$(cat "/valkey-auth-secret/${username}-password")
        log "Using inline password for user $username"
      else
        log "ERROR: No password found for user $username"
        return 1
      fi
      {{- end }}

      echo "$password"
    }
    {{- end }}

    # Clean old log if requested
    if [ "${KEEP_OLD_LOGS:-false}" != "true" ]; then
      rm -f "$LOGFILE"
    fi

    if [ -f "$LOGFILE" ]; then
      log "Detected restart of this instance ($HOSTNAME)"
    fi

    log "Creating configuration in $DATA_DIR..."
    mkdir -p "$DATA_DIR"
    rm -f "$VALKEY_CONFIG"


    # Base valkey.conf
    log "Generating base valkey.conf"
    {
{{- if .Values.tls.enabled }}
      echo "tls-cert-file /tls/{{ .Values.tls.serverPublicKey }}"
      echo "tls-key-file /tls/{{ .Values.tls.serverKey }}"
      echo "tls-ca-cert-file /tls/{{ .Values.tls.caPublicKey }}"
      {{- if .Values.tls.dhParamKey }}
      echo "tls-dh-params-file /tls/{{ .Values.tls.dhParamKey }}"
      {{- end }}
      {{- if not .Values.tls.requireClientCertificate }}
      echo "tls-auth-clients no"
      {{- end }}
      echo "port 0"
      echo "tls-port 6379"
{{- else }}
      echo "port 6379"
{{- end }}
      echo "protected-mode no"
      echo "bind * -::*"
      echo "dir /data"
    } >>"$VALKEY_CONFIG"

    {{- if .Values.auth.enabled }}
    # Create secure directory for ACL file
    log "Creating /etc/valkey directory for ACL file"
    mkdir -p /etc/valkey

    # Set aclfile path in valkey.conf
    echo "aclfile /etc/valkey/users.acl" >>"$VALKEY_CONFIG"

    # Remove or reset existing ACL file if present (it may be read-only from previous run)
    log "Preparing ACL file at /etc/valkey/users.acl"
    if [ -f /etc/valkey/users.acl ]; then
      log "Removing existing read-only users.acl file"
      chmod 0600 /etc/valkey/users.acl
      rm -f /etc/valkey/users.acl
    fi

    # Create ACL file with secure permissions
    touch /etc/valkey/users.acl
    chmod 0600 /etc/valkey/users.acl

    {{- if .Values.auth.aclUsers }}
    # Generate ACL entries for each user
    log "Generating ACL entries for users"
    {{- range $username, $user := .Values.auth.aclUsers }}
    {{- $passwordKey := $user.passwordKey | default $username }}

    # User: {{ $username }}
    PASSWORD=$(get_user_password "{{ $username }}" "{{ $passwordKey }}") || exit 1

    # Hash the password and write ACL entry
    PASSHASH=$(echo -n "$PASSWORD" | sha256sum | cut -f 1 -d " ")
    echo "user {{ $username }} on #$PASSHASH {{ $user.permissions }}" >> /etc/valkey/users.acl

    {{- end }}
    {{- end }}

    {{- if .Values.auth.aclConfig }}
    # Append inline ACL configuration
    log "Appending custom ACL configuration"
    if [ -f /valkey-auth-secret/aclConfig ]; then
      cat /valkey-auth-secret/aclConfig >> /etc/valkey/users.acl
    fi
    {{- end }}

    # Set final permissions
    chmod 0400 /etc/valkey/users.acl
    log "ACL file created with 0400 permissions"
    {{- end }}

    {{- if .Values.replica.enabled }}
    # Replica mode configuration
    log "Configuring replication mode"

    # Use POD_INDEX from Kubernetes metadata
    POD_INDEX=${POD_INDEX:-0}
    IS_MASTER=false

    # Check if this is pod-0 (master)
    if [ "$POD_INDEX" = "0" ]; then
      IS_MASTER=true
      log "This pod (index $POD_INDEX) is configured as MASTER"
    else
      log "This pod (index $POD_INDEX) is configured as REPLICA"
    fi

    # Configure replica settings
    if [ "$IS_MASTER" = "false" ]; then
      MASTER_HOST="{{ include "valkey.fullname" . }}-0.{{ include "valkey.headlessServiceName" . }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}"
      MASTER_PORT="{{ .Values.service.port }}"

      log "Configuring replica to follow master at $MASTER_HOST:$MASTER_PORT"

      {
        echo ""
        echo "# Replica Configuration"
        echo "replicaof $MASTER_HOST $MASTER_PORT"
        echo "replica-announce-ip {{ include "valkey.fullname" . }}-$POD_INDEX.{{ include "valkey.headlessServiceName" . }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}"
        {{- if .Values.replica.disklessSync }}
        echo ""
        echo "# Diskless replication"
        echo "repl-diskless-sync yes"
        echo "repl-diskless-sync-delay 5"
        {{- end }}
        {{- if .Values.auth.enabled }}
        echo ""
        echo "# Master authentication"
        {{- end }}
      } >>"$VALKEY_CONFIG"

      {{- if .Values.auth.enabled }}
      # Get the password for the replication user
      {{- $replUsername := .Values.replica.replicationUser }}
      REPL_PASSWORD=$(get_user_password "{{ $replUsername }}") || exit 1

      # Write masterauth configuration
      echo "masterauth $REPL_PASSWORD" >>"$VALKEY_CONFIG"
      echo "masteruser {{ $replUsername }}" >>"$VALKEY_CONFIG"
      log "Configured masterauth with user {{ $replUsername }}"
      {{- end }}

      {{- if .Values.tls.enabled }}
      # TLS for replication
      {
        echo ""
        echo "# TLS for replication"
        echo "tls-replication yes"
      } >>"$VALKEY_CONFIG"
      log "Enabled TLS for replication"
      {{- end }}
    fi

    {{- if gt (int .Values.replica.minReplicasToWrite) 0 }}
    # Write safety - require minimum healthy replicas
    {
      echo ""
      echo "# Minimum replicas for write operations"
      echo "min-replicas-to-write {{ .Values.replica.minReplicasToWrite }}"
      echo "min-replicas-max-lag {{ .Values.replica.minReplicasMaxLag }}"
    } >>"$VALKEY_CONFIG"
    log "Configured write safety: require {{ .Values.replica.minReplicasToWrite }} replicas with max {{ .Values.replica.minReplicasMaxLag }}s lag"
    {{- end }}
    {{- end }}

    # Append extra configs if present
    if [ -f /usr/local/etc/valkey/valkey.conf ]; then
      log "Appending /usr/local/etc/valkey/valkey.conf"
      cat /usr/local/etc/valkey/valkey.conf >>"$VALKEY_CONFIG"
    fi
    if [ -d /extravalkeyconfigs ]; then
      log "Appending files in /extravalkeyconfigs/"
      cat /extravalkeyconfigs/* >>"$VALKEY_CONFIG"
    fi

