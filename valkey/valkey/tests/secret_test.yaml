suite: secret generation
templates:
  - templates/secret.yaml
tests:
  - it: should not render secret when auth disabled
    set:
      auth.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render secret when auth enabled with usersExistingSecret only
    set:
      auth.enabled: true
      auth.usersExistingSecret: "my-secret"
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
      auth.aclConfig: ""
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secret with aclConfig only
    set:
      auth.enabled: true
      auth.aclConfig: "user admin on >password ~* &* +@all"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-valkey-auth
      - equal:
          path: type
          value: Opaque
      - exists:
          path: data.aclConfig

  - it: should render secret with aclUsers and inline passwords
    set:
      auth.enabled: true
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
        readonly:
          permissions: "~* +@read"
          password: "readonly-password"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-valkey-auth
      - equal:
          path: type
          value: Opaque
      - exists:
          path: data["admin-password"]
      - exists:
          path: data["readonly-password"]

  - it: should encode passwords correctly
    set:
      auth.enabled: true
      auth.aclUsers:
        testuser:
          permissions: "~* &* +@all"
          password: "mypassword"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data["testuser-password"]
          value: bXlwYXNzd29yZA==

  - it: should render secret with both aclUsers and aclConfig
    set:
      auth.enabled: true
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
      auth.aclConfig: "user guest on nopass ~public:* +@read"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - exists:
          path: data["admin-password"]
      - exists:
          path: data.aclConfig

  - it: should only include users with inline passwords in secret
    set:
      auth.enabled: true
      auth.usersExistingSecret: "my-secret"
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
        readonly:
          permissions: "~* +@read"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - exists:
          path: data["admin-password"]
      - notExists:
          path: data["readonly-password"]

  - it: should have correct labels
    set:
      auth.enabled: true
      auth.aclUsers:
        admin:
          permissions: "~* &* +@all"
          password: "admin-password"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: valkey
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
